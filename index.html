<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Solana Sniper | V8 Live Execution</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <style>
        body { background-color: #09090b; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; min-height: 100vh; }
        .terminal-log { background-color: #000; font-family: 'Courier New', Courier, monospace; height: 300px; overflow-y: auto; font-size: 0.85rem; color: #a1a1aa; border: 1px solid #27272a; }
        .signal-buy { color: #10b981; font-weight: bold; }
        .signal-sell { color: #ef4444; font-weight: bold; }
        .text-solana { color: #14F195; }
        .text-phantom { color: #AB9FF2; }
        .bg-panel { background-color: #18181b; border: 1px solid #27272a; }
        
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(20, 241, 149, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(20, 241, 149, 0); }
            100% { box-shadow: 0 0 0 0 rgba(20, 241, 149, 0); }
        }
        .btn-start-pulse { animation: pulse-green 2s infinite; background-color: #14F195; color: #000; border: none; }
        .btn-start-pulse:hover { background-color: #0fa868; color: #000; }
        .btn-phantom { background-color: #512DA8; color: white; border: none; transition: 0.3s; }
        .btn-phantom:hover { background-color: #311B92; color: white; }
    </style>
</head>
<body class="d-flex align-items-center py-4">

<div class="container bg-panel rounded-4 p-4 shadow-lg" style="max-width: 1000px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h2 class="text-solana fw-bold mb-0"><i class="fa-solid fa-bolt"></i> Sniper V8</h2>
            <small class="text-muted"><i class="fa-solid fa-satellite-dish"></i> Live Jupiter Execution Active</small>
        </div>
        <button class="btn btn-phantom fw-bold rounded-3 flex-grow-1 flex-md-grow-0" id="connectWalletBtn">
            <i class="fa-solid fa-wallet"></i> Connect Phantom
        </button>
    </div>

    <div class="row text-center mb-4 g-2">
        <div class="col-4 col-md-3">
            <div class="p-2 border border-dark rounded bg-dark h-100 d-flex flex-column justify-content-center">
                <small class="text-muted d-block mb-1">Trade Size</small>
                <span class="fw-bold text-solana fs-5"><i class="fa-solid fa-sack-dollar"></i> $2.00</span>
            </div>
        </div>
        <div class="col-8 col-md-9">
            <div class="p-2 border border-dark rounded bg-dark h-100 d-flex flex-column justify-content-center">
                <small class="text-muted d-block mb-1">Dynamic Risk Matrix</small>
                <div class="d-flex flex-column flex-md-row justify-content-around font-monospace" style="font-size: 11px;">
                    <span class="text-success">High: TP +50% / SL -10%</span>
                    <span class="text-warning">Mid: TP +100% / SL -20%</span>
                    <span class="text-danger">Low: TP +200% / SL -40%</span>
                </div>
            </div>
        </div>
    </div>

    <audio id="buySound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
    <audio id="sellSound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" preload="auto"></audio>

    <div class="d-grid gap-2 mb-4">
        <button class="btn btn-start-pulse btn-lg fw-bold rounded-3" id="startBtn">
            <i class="fa-solid fa-power-off"></i> Start Live Engine
        </button>
        <button class="btn btn-danger btn-lg fw-bold rounded-3" id="stopBtn" style="display: none;">
            <i class="fa-solid fa-hand"></i> Emergency Stop
        </button>
    </div>

    <div class="table-responsive mb-4 rounded border border-dark">
        <table class="table table-dark table-hover align-middle text-nowrap m-0">
            <thead class="table-active">
                <tr>
                    <th class="text-solana"><i class="fa-solid fa-coins"></i> Token</th>
                    <th class="text-solana"><i class="fa-solid fa-bullseye"></i> Target</th>
                    <th class="text-solana"><i class="fa-solid fa-chart-line"></i> Value</th>
                    <th class="text-solana"><i class="fa-solid fa-percent"></i> PnL</th>
                    <th class="text-solana"><i class="fa-solid fa-info-circle"></i> Status</th>
                </tr>
            </thead>
            <tbody id="portfolioBody">
                <tr><td colspan="5" class="text-center text-muted py-4"><i class="fa-solid fa-ghost fs-4 d-block mb-2"></i> No active positions</td></tr>
            </tbody>
        </table>
    </div>

    <div class="terminal-log rounded p-3" id="logBox"></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- DOM Elements ---
    const connectWalletBtn = document.getElementById('connectWalletBtn');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const logBox = document.getElementById('logBox');
    const portfolioBody = document.getElementById('portfolioBody');
    const buySound = document.getElementById('buySound');
    const sellSound = document.getElementById('sellSound');

    // --- State Variables ---
    let walletAddress = null;
    let scanInterval, priceMonitorInterval;
    let isScanning = false;
    let isMonitoring = false;
    let currentSolPrice = 150; // Fallback price
    
    let knownTokens = new Set(); 
    const MAX_KNOWN_TOKENS = 500; 
    
    let activePositions = {}; 
    let tradeHistory = []; 
    const TRADE_SIZE_USD = 2.00; 
    const SOL_MINT = "So11111111111111111111111111111111111111112";
    
    // --- Log Management ---
    const MAX_LOGS = 50; 
    let logHistory = [`<i class="fa-solid fa-terminal"></i> V8 System initialized. Connect wallet to begin.`];

    function initLog() { renderLogs(); }

    function log(message, type = '') {
        const timestamp = new Date().toLocaleTimeString([], { hour12: false });
        let prefix = `<span class="text-secondary">[${timestamp}]</span> `;
        
        if (type === 'buy') message = `<span class="signal-buy"><i class="fa-solid fa-cart-arrow-down"></i> BOUGHT: ${message}</span>`;
        if (type === 'sell') message = `<span class="signal-sell"><i class="fa-solid fa-money-bill-wave"></i> SELL ALERT: ${message}</span>`;
        if (type === 'scan') message = `<i class="fa-solid fa-radar text-info"></i> ${message}`;
        if (type === 'wallet') message = `<span class="text-phantom"><i class="fa-solid fa-wallet"></i> ${message}</span>`;
        if (type === 'error') message = `<span class="text-warning"><i class="fa-solid fa-triangle-exclamation"></i> ${message}</span>`;
        
        logHistory.push(`${prefix}${message}`);
        if (logHistory.length > MAX_LOGS) logHistory.shift(); 
        renderLogs();
    }

    function renderLogs() {
        logBox.innerHTML = logHistory.join('<br>');
        logBox.scrollTop = logBox.scrollHeight;
    }

    // --- Helpers ---
    function base64ToUint8Array(base64) {
        const binaryString = atob(base64);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes;
    }

    async function fetchLiveSolPrice() {
        try {
            const res = await fetch(`https://api.geckoterminal.com/api/v2/simple/networks/solana/token_price/${SOL_MINT}`);
            const data = await res.json();
            currentSolPrice = parseFloat(data.data.attributes.token_prices[SOL_MINT]);
            log(`Live SOL Price updated: $${currentSolPrice.toFixed(2)}`, "scan");
        } catch (e) {
            log(`Could not fetch live SOL price. Using fallback $${currentSolPrice}`, "error");
        }
    }

    // --- 1. MOBILE AUTO-DETECTION & DEEP LINKING ---
    connectWalletBtn.addEventListener('click', async () => {
        const provider = window.phantom?.solana;
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        if (provider?.isPhantom) {
            try {
                const resp = await provider.connect();
                walletAddress = resp.publicKey.toString();
                connectWalletBtn.innerHTML = `<i class="fa-solid fa-link"></i> ${walletAddress.substring(0,4)}...${walletAddress.slice(-4)}`;
                connectWalletBtn.classList.replace('btn-phantom', 'btn-success');
                log(`Wallet connected: ${walletAddress}`, "wallet");
            } catch (err) {
                log(`Connection rejected by user.`, "error");
            }
        } else {
            if (isMobile) {
                log("Redirecting to Phantom Mobile App...", "wallet");
                const currentUrl = encodeURIComponent(window.location.href);
                const ref = encodeURIComponent(window.location.origin);
                window.location.href = `https://phantom.app/ul/browse/${currentUrl}?ref=${ref}`;
            } else {
                log("Phantom extension not found.", "error");
                window.open('https://phantom.app/', '_blank');
            }
        }
    });

    function calculateDynamicTargets(liquidity) {
        if (liquidity >= 50000) return { tp: 50, sl: -10 }; 
        if (liquidity >= 10000) return { tp: 100, sl: -20 }; 
        return { tp: 200, sl: -40 }; 
    }

    // --- 2. JUPITER LIVE EXECUTION ---
    async function executeRealBuy(tokenAddress, name, price, liquidity) {
        log(`<i class="fa-solid fa-gears text-warning"></i> Generating Jupiter Route for ${name}...`);

        try {
            const solAmount = TRADE_SIZE_USD / currentSolPrice;
            const lamports = Math.floor(solAmount * 1e9); 

            // Request Quote (5% slippage = 500 bps)
            const quoteResponse = await fetch(`https://quote-api.jup.ag/v6/quote?inputMint=${SOL_MINT}&outputMint=${tokenAddress}&amount=${lamports}&slippageBps=500`);
            const quoteData = await quoteResponse.json();

            if (quoteData.error) throw new Error(quoteData.error);

            log(`<i class="fa-solid fa-route text-success"></i> Route found! Requesting transaction data...`);

            // Request Serialized Transaction
            const swapResponse = await fetch('https://quote-api.jup.ag/v6/swap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    quoteResponse: quoteData,
                    userPublicKey: walletAddress,
                    wrapAndUnwrapSol: true
                })
            });
            
            const swapData = await swapResponse.json();
            if (!swapData.swapTransaction) throw new Error("Failed to generate swap transaction.");

            // Decode and send to Phantom
            const swapTransactionBuf = base64ToUint8Array(swapData.swapTransaction);
            const transaction = solanaWeb3.VersionedTransaction.deserialize(swapTransactionBuf);

            log(`<i class="fa-solid fa-signature text-warning"></i> Transaction ready! Please approve in Phantom...`);
            
            const provider = window.phantom?.solana;
            const { signature } = await provider.signAndSendTransaction(transaction);

            log(`TX Submitted! Sig: ${signature.substring(0,8)}...`, "buy");
            buySound.play().catch(() => {});

            // Log position
            const riskParams = calculateDynamicTargets(liquidity);
            activePositions[tokenAddress] = {
                id: Date.now(),
                address: tokenAddress,
                name: name,
                entryPrice: price,
                currentPrice: price,
                tokens: TRADE_SIZE_USD / price,
                currentValue: TRADE_SIZE_USD,
                tpTarget: riskParams.tp,
                slTarget: riskParams.sl,
                status: 'Holding',
                pnl: 0
            };
            
            tradeHistory.unshift(tokenAddress); 
            updatePortfolioUI();

        } catch (error) {
            log(`Execution failed: ${error.message}`, "error");
        }
    }

    // --- 3. ASYNC SAFE SCANNER ---
    async function scanMarket() {
        if (!walletAddress || isScanning) return;
        isScanning = true;
        
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            const response = await fetch('https://api.geckoterminal.com/api/v2/networks/solana/new_pools', { signal: controller.signal });
            clearTimeout(timeoutId);
            if (!response.ok) throw new Error("API Limit");
            
            const data = await response.json();
            if (!data?.data) return;

            if (knownTokens.size > MAX_KNOWN_TOKENS) knownTokens.clear();

            for (let i = 0; i < 5; i++) {
                if (!data.data[i]) continue; 

                const pool = data.data[i].attributes;
                const tokenData = data.data[i].relationships?.base_token?.data;
                if (!pool || !tokenData) continue; 

                const tokenAddress = tokenData.id.replace('solana_', '');
                const tokenName = pool.name.split(' / ')[0].substring(0, 10); 
                const price = parseFloat(pool.base_token_price_usd);
                const liquidity = parseFloat(pool.reserve_in_usd);

                if (isNaN(price) || isNaN(liquidity)) continue; 
                if (knownTokens.has(tokenAddress)) continue;
                
                knownTokens.add(tokenAddress);

                if (liquidity >= 5000 && price > 0) {
                    executeRealBuy(tokenAddress, tokenName, price, liquidity);
                }
            }
        } catch (error) {} finally { isScanning = false; }
    }

    // --- 4. PRICE MONITOR ---
    async function monitorPrices() {
        if (isMonitoring) return; 
        const activeAddresses = tradeHistory.filter(addr => activePositions[addr].status === 'Holding');
        if (activeAddresses.length === 0) return;

        isMonitoring = true;
        const batch = activeAddresses.slice(0, 30); 
        
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            const addressString = batch.join(',');
            const response = await fetch(`https://api.geckoterminal.com/api/v2/simple/networks/solana/token_price/${addressString}`, { signal: controller.signal });
            clearTimeout(timeoutId);
            
            if (!response.ok) throw new Error("API Limit");
            const data = await response.json();

            if (!data?.data?.attributes?.token_prices) return;
            const prices = data.data.attributes.token_prices;

            for (const address of batch) {
                if (prices[address]) {
                    const newPrice = parseFloat(prices[address]);
                    if (isNaN(newPrice) || newPrice <= 0) continue;

                    const pos = activePositions[address];
                    const pnlPercent = ((newPrice - pos.entryPrice) / pos.entryPrice) * 100;
                    
                    pos.currentPrice = newPrice;
                    pos.currentValue = pos.tokens * newPrice;
                    pos.pnl = pnlPercent;

                    if (pnlPercent >= pos.tpTarget) triggerSell(address, `Auto-TP (+${pnlPercent.toFixed(1)}%)`);
                    else if (pnlPercent <= pos.slTarget) triggerSell(address, `Auto-SL (${pnlPercent.toFixed(1)}%)`);
                }
            }
            updatePortfolioUI();

        } catch (error) {} finally { isMonitoring = false; }
    }

    // --- 5. ALERTS ---
    function triggerSell(address, reason) {
        // NOTE: In a fully autonomous system, this would trigger executeRealSell() via Jupiter.
        // For frontend safety, we trigger an alert so you can sell via Jupiter UI manually.
        activePositions[address].status = `Sold (${reason})`;
        sellSound.play().catch(() => {}); 
        log(`${activePositions[address].name} closed: ${reason} for $${activePositions[address].currentValue.toFixed(2)}`, "sell");
    }

    // --- 6. RENDERER ---
    function updatePortfolioUI() {
        if (tradeHistory.length === 0) return;

        let htmlRender = '';
        let renderCount = 0;
        
        for (const address of tradeHistory) {
            if (renderCount >= 20) break;
            
            const pos = activePositions[address];
            const isHolding = pos.status === 'Holding';
            
            let pnlDisplay = "0.00%";
            let pnlClass = "text-secondary";
            let statusIcon = '<i class="fa-regular fa-gem text-info"></i>';

            if (pos.pnl !== 0) {
                pnlDisplay = `${pos.pnl > 0 ? '+' : ''}${pos.pnl.toFixed(2)}%`;
                pnlClass = pos.pnl > 0 ? 'text-success fw-bold' : 'text-danger fw-bold';
            }

            if (!isHolding) statusIcon = pos.pnl > 0 ? '<i class="fa-solid fa-check text-success"></i>' : '<i class="fa-solid fa-times text-danger"></i>';

            const rowOpacity = isHolding ? '1' : '0.4';

            htmlRender += `
                <tr style="opacity: ${rowOpacity};">
                    <td><strong>${pos.name}</strong><br><small class="text-muted"><a href="https://dexscreener.com/solana/${address}" target="_blank" class="text-info text-decoration-none">${address.substring(0,6)}...</a></small></td>
                    <td>$${pos.entryPrice.toFixed(6)}<br><small class="text-muted">T: +${pos.tpTarget}% / S: ${pos.slTarget}%</small></td>
                    <td>$${pos.currentValue.toFixed(2)}</td>
                    <td class="${pnlClass}">${pnlDisplay}</td>
                    <td>${statusIcon} ${pos.status}</td>
                </tr>
            `;
            renderCount++;
        }
        portfolioBody.innerHTML = htmlRender;
    }

    // --- CONTROLS ---
    startBtn.addEventListener('click', async () => {
        if (!walletAddress) {
            alert("Please connect your Phantom Wallet first.");
            return;
        }

        buySound.play().catch(() => {}); 
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        
        log("<i class='fa-solid fa-play text-success'></i> Live Engine Started.");
        
        await fetchLiveSolPrice(); // Get accurate SOL price before trading
        
        scanMarket();
        scanInterval = setInterval(scanMarket, 18000); 
        priceMonitorInterval = setInterval(monitorPrices, 30000); 
    });

    stopBtn.addEventListener('click', () => {
        startBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        
        clearInterval(scanInterval);
        clearInterval(priceMonitorInterval);
        isScanning = false;
        isMonitoring = false;
        
        log("<i class='fa-solid fa-stop text-danger'></i> Engine Stopped.");
    });

    initLog();
</script>

</body>
</html>
