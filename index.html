<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Solana Sniper | V6 Zero-Lag</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <style>
        body { background-color: #09090b; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; min-height: 100vh; }
        .terminal-log { background-color: #000; font-family: 'Courier New', Courier, monospace; height: 300px; overflow-y: auto; font-size: 0.85rem; color: #a1a1aa; border: 1px solid #27272a; }
        .signal-buy { color: #10b981; font-weight: bold; }
        .signal-sell { color: #ef4444; font-weight: bold; }
        .text-solana { color: #14F195; }
        .text-phantom { color: #AB9FF2; }
        .bg-panel { background-color: #18181b; border: 1px solid #27272a; }
        
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(20, 241, 149, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(20, 241, 149, 0); }
            100% { box-shadow: 0 0 0 0 rgba(20, 241, 149, 0); }
        }
        .btn-start-pulse { animation: pulse-green 2s infinite; background-color: #14F195; color: #000; border: none; }
        .btn-start-pulse:hover { background-color: #0fa868; color: #000; }
        .btn-phantom { background-color: #512DA8; color: white; border: none; }
        .btn-phantom:hover { background-color: #311B92; color: white; }
    </style>
</head>
<body class="d-flex align-items-center py-4">

<div class="container bg-panel rounded-4 p-4 shadow-lg" style="max-width: 1000px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-solana fw-bold mb-0"><i class="fa-solid fa-bolt"></i> Sniper V6</h2>
            <small class="text-muted"><i class="fa-solid fa-microchip"></i> Zero-Lag Engine Active</small>
        </div>
        <button class="btn btn-phantom fw-bold rounded-3" id="connectWalletBtn">
            <i class="fa-solid fa-wallet"></i> Connect Phantom
        </button>
    </div>

    <div class="row text-center mb-4 g-2">
        <div class="col-3">
            <div class="p-2 border border-dark rounded bg-dark h-100 d-flex flex-column justify-content-center">
                <small class="text-muted d-block mb-1">Trade Size</small>
                <span class="fw-bold text-solana fs-5"><i class="fa-solid fa-sack-dollar"></i> $2.00</span>
            </div>
        </div>
        <div class="col-9">
            <div class="p-2 border border-dark rounded bg-dark h-100 d-flex flex-column justify-content-center">
                <small class="text-muted d-block mb-1">Dynamic Risk Matrix</small>
                <div class="d-flex justify-content-around font-monospace" style="font-size: 12px;">
                    <span class="text-success">High Liq: TP +50% / SL -10%</span>
                    <span class="text-warning">Mid Liq: TP +100% / SL -20%</span>
                    <span class="text-danger">Low Liq: TP +200% / SL -40%</span>
                </div>
            </div>
        </div>
    </div>

    <audio id="buySound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
    <audio id="sellSound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" preload="auto"></audio>

    <div class="d-grid gap-2 mb-4">
        <button class="btn btn-start-pulse btn-lg fw-bold rounded-3" id="startBtn">
            <i class="fa-solid fa-power-off"></i> Start Engine
        </button>
        <button class="btn btn-danger btn-lg fw-bold rounded-3" id="stopBtn" style="display: none;">
            <i class="fa-solid fa-hand"></i> Emergency Stop
        </button>
    </div>

    <div class="table-responsive mb-4 rounded border border-dark">
        <table class="table table-dark table-hover align-middle text-nowrap m-0">
            <thead class="table-active">
                <tr>
                    <th class="text-solana"><i class="fa-solid fa-coins"></i> Token</th>
                    <th class="text-solana"><i class="fa-solid fa-bullseye"></i> Entry (Target)</th>
                    <th class="text-solana"><i class="fa-solid fa-chart-line"></i> Value</th>
                    <th class="text-solana"><i class="fa-solid fa-percent"></i> PnL</th>
                    <th class="text-solana"><i class="fa-solid fa-info-circle"></i> Status</th>
                </tr>
            </thead>
            <tbody id="portfolioBody">
                <tr><td colspan="5" class="text-center text-muted py-4"><i class="fa-solid fa-ghost fs-4 d-block mb-2"></i> No active positions</td></tr>
            </tbody>
        </table>
    </div>

    <div class="terminal-log rounded p-3" id="logBox"></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const connectWalletBtn = document.getElementById('connectWalletBtn');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const logBox = document.getElementById('logBox');
    const portfolioBody = document.getElementById('portfolioBody');
    const buySound = document.getElementById('buySound');
    const sellSound = document.getElementById('sellSound');

    let walletAddress = null;
    let scanInterval, priceMonitorInterval;
    
    // Performance Locks
    let isScanning = false;
    let isMonitoring = false;
    
    // Memory Management
    let knownTokens = new Set(); 
    const MAX_KNOWN_TOKENS = 500; // Prevents memory leaks
    
    // State Management
    let activePositions = {}; 
    let tradeHistory = []; // Keeps track of order for rendering
    const TRADE_SIZE_USD = 2.00; 
    
    // Log Management
    const MAX_LOGS = 50; 
    let logHistory = [`<i class="fa-solid fa-terminal"></i> System initialized. Connect wallet to begin.`];

    function initLog() { renderLogs(); }

    function log(message, type = '') {
        const timestamp = new Date().toLocaleTimeString([], { hour12: false });
        let prefix = `<span class="text-secondary">[${timestamp}]</span> `;
        
        if (type === 'buy') message = `<span class="signal-buy"><i class="fa-solid fa-cart-arrow-down"></i> BOUGHT: ${message}</span>`;
        if (type === 'sell') message = `<span class="signal-sell"><i class="fa-solid fa-money-bill-wave"></i> SELL ALERT: ${message}</span>`;
        if (type === 'scan') message = `<i class="fa-solid fa-radar text-info"></i> ${message}`;
        if (type === 'wallet') message = `<span class="text-phantom"><i class="fa-solid fa-wallet"></i> ${message}</span>`;
        if (type === 'error') message = `<span class="text-warning"><i class="fa-solid fa-triangle-exclamation"></i> ${message}</span>`;
        
        logHistory.push(`${prefix}${message}`);
        if (logHistory.length > MAX_LOGS) logHistory.shift(); 
        renderLogs();
    }

    function renderLogs() {
        logBox.innerHTML = logHistory.join('<br>');
        logBox.scrollTop = logBox.scrollHeight;
    }

    // --- 1. PHANTOM WALLET ---
    connectWalletBtn.addEventListener('click', async () => {
        try {
            const provider = window.phantom?.solana;
            if (!provider?.isPhantom) {
                log("Phantom wallet not found. Please install extension.", "error");
                window.open('https://phantom.app/', '_blank');
                return;
            }
            const resp = await provider.connect();
            walletAddress = resp.publicKey.toString();
            connectWalletBtn.innerHTML = `<i class="fa-solid fa-link"></i> ${walletAddress.substring(0,4)}...${walletAddress.slice(-4)}`;
            connectWalletBtn.classList.replace('btn-phantom', 'btn-success');
            log(`Wallet connected successfully: ${walletAddress}`, "wallet");
        } catch (err) {
            log(`Wallet connection failed.`, "error");
        }
    });

    function calculateDynamicTargets(liquidity) {
        if (liquidity >= 50000) return { tp: 50, sl: -10 }; 
        if (liquidity >= 10000) return { tp: 100, sl: -20 }; 
        return { tp: 200, sl: -40 }; 
    }

    // --- 2. ASYNC SAFE SCANNER ---
    async function scanMarket() {
        if (!walletAddress) return;
        if (isScanning) return; // Prevent async collisions if API is lagging
        
        isScanning = true;
        
        try {
            // AbortController to kill hanging API requests after 10 seconds
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            const response = await fetch('https://api.geckoterminal.com/api/v2/networks/solana/new_pools', { signal: controller.signal });
            clearTimeout(timeoutId);
            
            if (!response.ok) throw new Error("API Rate Limit");
            
            const data = await response.json();
            if (!data?.data) {
                isScanning = false;
                return;
            }

            // Memory Leak Prevention: Clear Set if it gets too large
            if (knownTokens.size > MAX_KNOWN_TOKENS) knownTokens.clear();

            for (let i = 0; i < 5; i++) {
                if (!data.data[i]) continue; 

                const pool = data.data[i].attributes;
                const tokenData = data.data[i].relationships?.base_token?.data;
                if (!pool || !tokenData) continue; 

                const tokenAddress = tokenData.id.replace('solana_', '');
                const tokenName = pool.name.split(' / ')[0].substring(0, 10); 
                
                const price = parseFloat(pool.base_token_price_usd);
                const liquidity = parseFloat(pool.reserve_in_usd);

                if (isNaN(price) || isNaN(liquidity)) continue; 

                if (knownTokens.has(tokenAddress)) continue;
                knownTokens.add(tokenAddress);

                // Entry Condition
                if (liquidity >= 5000 && price > 0) {
                    executeBuy(tokenAddress, tokenName, price, liquidity);
                }
            }
        } catch (error) {
            // Silently handle timeouts to prevent log spam
        } finally {
            isScanning = false; // Release lock
        }
    }

    // --- 3. EXECUTION ---
    function executeBuy(address, name, price, liquidity) {
        const riskParams = calculateDynamicTargets(liquidity);
        const tokensBought = TRADE_SIZE_USD / price;

        activePositions[address] = {
            id: Date.now(),
            address: address,
            name: name,
            entryPrice: price,
            currentPrice: price,
            tokens: tokensBought,
            currentValue: TRADE_SIZE_USD,
            tpTarget: riskParams.tp,
            slTarget: riskParams.sl,
            status: 'Holding',
            pnl: 0
        };
        
        // Add to history for rendering order
        tradeHistory.unshift(address); 
        
        buySound.play().catch(() => {}); 
        log(`$2.00 of ${name} | TP: +${riskParams.tp}% / SL: ${riskParams.sl}%`, "buy");
        updatePortfolioUI();
    }

    // --- 4. ASYNC SAFE PRICE MONITOR ---
    async function monitorPrices() {
        if (isMonitoring) return; // Prevent async collisions
        
        const activeAddresses = tradeHistory.filter(addr => activePositions[addr].status === 'Holding');
        if (activeAddresses.length === 0) return;

        isMonitoring = true;
        const batch = activeAddresses.slice(0, 30); 
        
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            const addressString = batch.join(',');
            const response = await fetch(`https://api.geckoterminal.com/api/v2/simple/networks/solana/token_price/${addressString}`, { signal: controller.signal });
            clearTimeout(timeoutId);
            
            if (!response.ok) throw new Error("API Limit");
            const data = await response.json();

            if (!data?.data?.attributes?.token_prices) {
                isMonitoring = false;
                return;
            }
            
            const prices = data.data.attributes.token_prices;

            for (const address of batch) {
                if (prices[address]) {
                    const newPrice = parseFloat(prices[address]);
                    if (isNaN(newPrice) || newPrice <= 0) continue;

                    const pos = activePositions[address];
                    const pnlPercent = ((newPrice - pos.entryPrice) / pos.entryPrice) * 100;
                    
                    pos.currentPrice = newPrice;
                    pos.currentValue = pos.tokens * newPrice;
                    pos.pnl = pnlPercent;

                    // TP/SL Checks
                    if (pnlPercent >= pos.tpTarget) {
                        triggerSell(address, `Auto-TP (+${pnlPercent.toFixed(1)}%)`);
                    } else if (pnlPercent <= pos.slTarget) {
                        triggerSell(address, `Auto-SL (${pnlPercent.toFixed(1)}%)`);
                    }
                }
            }
            updatePortfolioUI();

        } catch (error) {
            // Silently fail on timeout
        } finally {
            isMonitoring = false; // Release lock
        }
    }

    // --- 5. ALERTS ---
    function triggerSell(address, reason) {
        activePositions[address].status = `Sold (${reason})`;
        sellSound.play().catch(() => {}); 
        log(`${activePositions[address].name} closed: ${reason} for $${activePositions[address].currentValue.toFixed(2)}`, "sell");
    }

    // --- 6. OPTIMIZED DOM RENDERER ---
    function updatePortfolioUI() {
        if (tradeHistory.length === 0) return;

        let htmlRender = '';
        let renderCount = 0;
        
        // DOM Optimization: Only render the 20 most recent items to prevent UI lag
        for (const address of tradeHistory) {
            if (renderCount >= 20) break;
            
            const pos = activePositions[address];
            const isHolding = pos.status === 'Holding';
            
            let pnlDisplay = "0.00%";
            let pnlClass = "text-secondary";
            let statusIcon = '<i class="fa-regular fa-gem text-info"></i>';

            if (pos.pnl !== 0) {
                pnlDisplay = `${pos.pnl > 0 ? '+' : ''}${pos.pnl.toFixed(2)}%`;
                pnlClass = pos.pnl > 0 ? 'text-success fw-bold' : 'text-danger fw-bold';
            }

            if (!isHolding) {
                statusIcon = pos.pnl > 0 ? '<i class="fa-solid fa-check text-success"></i>' : '<i class="fa-solid fa-times text-danger"></i>';
            }

            const rowOpacity = isHolding ? '1' : '0.4';

            htmlRender += `
                <tr style="opacity: ${rowOpacity};">
                    <td><strong>${pos.name}</strong><br><small class="text-muted">${address.substring(0,6)}...</small></td>
                    <td>$${pos.entryPrice.toFixed(6)}<br><small class="text-muted">T: +${pos.tpTarget}% / S: ${pos.slTarget}%</small></td>
                    <td>$${pos.currentValue.toFixed(2)}</td>
                    <td class="${pnlClass}">${pnlDisplay}</td>
                    <td>${statusIcon} ${pos.status}</td>
                </tr>
            `;
            renderCount++;
        }
        portfolioBody.innerHTML = htmlRender;
    }

    // --- CONTROLS ---
    startBtn.addEventListener('click', () => {
        if (!walletAddress) {
            alert("Please connect your Phantom Wallet first.");
            return;
        }

        buySound.play().catch(() => {}); 
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        
        log("<i class='fa-solid fa-play text-success'></i> Zero-Lag Engine Started.");
        
        // Initial scan, then loops
        scanMarket();
        scanInterval = setInterval(scanMarket, 18000); 
        priceMonitorInterval = setInterval(monitorPrices, 30000); 
    });

    stopBtn.addEventListener('click', () => {
        startBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        
        clearInterval(scanInterval);
        clearInterval(priceMonitorInterval);
        
        // Reset locks in case stopped during an API call
        isScanning = false;
        isMonitoring = false;
        
        log("<i class='fa-solid fa-stop text-danger'></i> Engine Stopped.");
    });

    initLog();
</script>

</body>
</html>
