<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Solana Auto-Sniper | REAL MAINNET</title>
    
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://bundle.run/bs58@5.0.0"></script>
    <script src="https://bundle.run/buffer@6.0.3"></script>

    <style>
        :root {
            --sol-green: #14F195;
            --sol-purple: #9945FF;
            --bg-dark: #09090b;
            --panel-bg: #18181b;
            --panel-border: #27272a;
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            background-color: var(--panel-bg);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--panel-border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .header { text-align: center; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        h1 { color: var(--sol-green); font-size: 24px; font-weight: 700; }
        .subtitle { color: var(--danger); font-size: 14px; font-weight: bold; background: rgba(239, 68, 68, 0.1); padding: 5px 10px; border-radius: 5px;}

        /* Private Key Input Style */
        .wallet-setup {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--panel-border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .wallet-setup label { font-size: 13px; color: var(--sol-purple); font-weight: bold; }
        .pk-input {
            width: 100%;
            padding: 12px;
            background: #000;
            border: 1px solid var(--panel-border);
            color: var(--sol-green);
            border-radius: 6px;
            font-family: monospace;
        }
        .pk-input:focus { outline: none; border-color: var(--sol-green); }
        .pubkey-display { font-size: 12px; color: var(--success); display: none; margin-top: 5px; text-align: center;}

        .filters {
            display: flex;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--panel-border);
            font-size: 14px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .filters div { flex: 1; text-align: center; min-width: 100px; }
        
        input[type="number"] {
            background: transparent;
            border: none;
            color: var(--sol-green);
            font-weight: bold;
            width: 60px;
            text-align: center;
            border-bottom: 1px solid var(--sol-green);
        }
        input[type="number"]:focus { outline: none; }

        .btn-group { display: flex; gap: 10px; flex-direction: column; }
        button {
            width: 100%;
            padding: 16px;
            border-radius: 10px;
            border: none;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            text-transform: uppercase;
        }
        button:active { transform: scale(0.98); }
        .btn-start { background-color: var(--sol-green); color: #000; }
        .btn-start:hover { opacity: 0.9; }
        .btn-stop { background-color: var(--danger); color: #fff; display: none; }
        .btn-stop:hover { opacity: 0.9; }

        .table-wrapper { width: 100%; overflow-x: auto; border-radius: 8px; border: 1px solid var(--panel-border); }
        table { width: 100%; min-width: 600px; border-collapse: collapse; background-color: rgba(0,0,0,0.2); }
        th, td { padding: 14px 16px; text-align: left; font-size: 14px; border-bottom: 1px solid var(--panel-border); }
        th { background-color: rgba(20, 241, 149, 0.1); color: var(--sol-green); font-weight: 600; }
        .profit { color: var(--success); font-weight: bold; }
        .loss { color: var(--danger); font-weight: bold; }

        .log-box {
            background-color: #000;
            padding: 16px;
            border-radius: 10px;
            font-family: monospace;
            height: 250px;
            overflow-y: auto;
            font-size: 13px;
            color: var(--text-muted);
            border: 1px solid var(--panel-border);
            line-height: 1.5;
        }
        .signal-buy { color: var(--success); font-weight: bold; }
        .signal-sell { color: var(--danger); font-weight: bold; }
        .signal-tx { color: #3b82f6; font-weight: bold; }
        .loss { color: var(--danger); }

        @media (max-width: 600px) {
            .filters { flex-direction: column; }
            .filters div { padding: 5px 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>‚ö° Solana Auto-Sniper</h1>
        <div class="subtitle">‚ö†Ô∏è 100% AUTOMATED - USE BURNER WALLETS ONLY</div>
    </div>

    <div class="wallet-setup">
        <label>Burner Wallet Private Key (Base58 Format)</label>
        <input type="password" id="privateKeyInput" class="pk-input" placeholder="Paste Private Key from Phantom Export here...">
        <div id="pubkeyDisplay" class="pubkey-display"></div>
    </div>

    <div class="filters">
        <div><strong>Buy Amount:</strong> $<input type="number" id="usdAmount" value="2" step="1"></div>
        <div><strong>Take Profit:</strong> <input type="number" id="tpInput" value="30">%</div>
        <div><strong>Stop Loss:</strong> <input type="number" id="slInput" value="-15">%</div>
    </div>

    <audio id="buySound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
    <audio id="sellSound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" preload="auto"></audio>

    <div class="btn-group">
        <button class="btn-start" id="startBtn">üöÄ Start Auto-Pilot</button>
        <button class="btn-stop" id="stopBtn">üõë Emergency Stop</button>
    </div>

    <div class="table-wrapper">
        <table id="portfolioTable">
            <thead>
                <tr>
                    <th>Token</th>
                    <th>Entry ($)</th>
                    <th>Current ($)</th>
                    <th>PnL %</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="portfolioBody">
                <tr><td colspan="5" style="text-align:center; color: #666;">No active positions</td></tr>
            </tbody>
        </table>
    </div>

    <div class="log-box" id="logBox"></div>
</div>

<script>
    // --- GLOBAL VARIABLES & SETUP ---
    const SOL_MINT = "So11111111111111111111111111111111111111112"; 
    
    // Connection to Mainnet
    const connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com", "confirmed");
    
    let payerKeypair = null; 
    let activePositions = {}; 
    let knownTokens = new Set();
    let scanInterval, priceMonitorInterval;
    
    // UI Elements
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const pkInput = document.getElementById('privateKeyInput');
    const pubkeyDisplay = document.getElementById('pubkeyDisplay');
    const logBox = document.getElementById('logBox');
    const portfolioBody = document.getElementById('portfolioBody');
    const buySound = document.getElementById('buySound');
    const sellSound = document.getElementById('sellSound');

    // Logging System
    let logHistory = ["> System Booted. Waiting for Private Key initialization..."];
    function log(msg, type = '') {
        const time = new Date().toLocaleTimeString([], { hour12: false });
        let prefix = `<span style="color:#555">[${time}]</span> `;
        if (type === 'buy') msg = `<span class="signal-buy">‚úÖ BUY EXECUTED: ${msg}</span>`;
        if (type === 'sell') msg = `<span class="signal-sell">üö® SELL EXECUTED: ${msg}</span>`;
        if (type === 'tx') msg = `<span class="signal-tx">üîó ${msg}</span>`;
        if (type === 'error') msg = `<span class="loss">‚ùå ${msg}</span>`;
        if (type === 'success') msg = `<span class="profit">‚úÖ ${msg}</span>`;
        
        logHistory.push(`${prefix}${msg}`);
        if (logHistory.length > 50) logHistory.shift(); 
        logBox.innerHTML = logHistory.join('<br>');
        logBox.scrollTop = logBox.scrollHeight;
    }

    // --- 1. KEYPAIR INITIALIZATION (NO WALLET POPUPS) ---
    function initializeWallet() {
        try {
            const pkString = pkInput.value.trim();
            if (!pkString) throw new Error("Private key is empty.");
            
            // Decode Base58 string to Uint8Array and create Keypair
            const secretKey = bs58.decode(pkString);
            payerKeypair = solanaWeb3.Keypair.fromSecretKey(secretKey);
            
            const pubKey = payerKeypair.publicKey.toString();
            pubkeyDisplay.innerText = `Identity Verified: ${pubKey}`;
            pubkeyDisplay.style.display = 'block';
            pkInput.style.display = 'none'; // Hide PK input for safety
            
            log(`Wallet loaded securely: ${pubKey.slice(0,6)}...${pubKey.slice(-4)}`, "success");
            return true;
        } catch (error) {
            log("Invalid Private Key format. Please check your input.", "error");
            return false;
        }
    }

    // --- 2. JUPITER API: 100% AUTOMATED SWAP EXECUTION ---
    async function executeRealSwap(inputMint, outputMint, amount, isSell = false, tokenName = "Token") {
        if (!payerKeypair) return false;

        try {
            log(`Fetching routing quote for ${tokenName}...`, 'tx');
            
            // 1. Get Quote
            const quoteResponse = await fetch(`https://quote-api.jup.ag/v6/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amount}&slippageBps=200`); 
            const quoteData = await quoteResponse.json();
            
            if (quoteData.error) throw new Error(`Quote Error: ${quoteData.error}`);

            log(`Building transaction payload...`, 'tx');

            // 2. Build Swap Transaction payload for the exact wallet address
            const swapResponse = await fetch('https://quote-api.jup.ag/v6/swap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    quoteResponse: quoteData,
                    userPublicKey: payerKeypair.publicKey.toString(),
                    wrapAndUnwrapSol: true,
                })
            });
            const swapData = await swapResponse.json();
            if (swapData.error) throw new Error(`Swap Error: ${swapData.error}`);

            // 3. Deserialize Transaction
            const swapTransactionBuf = buffer.Buffer.from(swapData.swapTransaction, 'base64');
            const transaction = solanaWeb3.VersionedTransaction.deserialize(swapTransactionBuf);

            log(`Signing transaction automatically...`, 'tx');
            
            // 4. THE MAGIC: Sign instantly with the loaded Private Key (Zero Clicks)
            transaction.sign([payerKeypair]);
            const rawTransaction = transaction.serialize();
            
            // 5. Blast it to the network
            const txid = await connection.sendRawTransaction(rawTransaction, { skipPreflight: true, maxRetries: 2 });

            log(`Tx Broadcasted: https://solscan.io/tx/${txid}`, 'tx');
            return txid;

        } catch (error) {
            log(`Swap execution failed: ${error.message}`, "error");
            return false;
        }
    }

    // --- 3. MARKET SCANNER & DYNAMIC BUY ---
    async function scanMarket() {
        log("üì° Sweeping for new pairs...");
        try {
            const response = await fetch('https://api.geckoterminal.com/api/v2/networks/solana/new_pools');
            const data = await response.json();
            if (!data?.data) return;

            const pool = data.data[0].attributes;
            const tokenData = data.data[0].relationships?.base_token?.data;
            if (!pool || !tokenData) return;

            const tokenAddress = tokenData.id.replace('solana_', '');
            const tokenName = pool.name.split(' / ')[0].substring(0, 10);
            const price = parseFloat(pool.base_token_price_usd);
            const liquidity = parseFloat(pool.reserve_in_usd);

            if (knownTokens.has(tokenAddress)) return;
            knownTokens.add(tokenAddress);

            // Filter
            if (liquidity >= 5000 && price > 0) {
                
                log(`Target Acquired: ${tokenName}. Calculating $2 -> SOL...`, "tx");
                
                // Fetch dynamic SOL Price
                const solPriceResp = await fetch('https://api.jup.ag/price/v2?ids=So11111111111111111111111111111111111111112');
                const solPriceData = await solPriceResp.json();
                const solUsdPrice = parseFloat(solPriceData.data[SOL_MINT].price);

                const targetUsdAmount = parseFloat(document.getElementById('usdAmount').value);
                const solAmount = targetUsdAmount / solUsdPrice;
                const lamports = Math.floor(solAmount * 1000000000); 

                log(`Executing Auto-Buy: ${solAmount.toFixed(4)} SOL of ${tokenName}...`, "tx");
                
                // EXECUTE BUY WITHOUT ASKING
                const txid = await executeRealSwap(SOL_MINT, tokenAddress, lamports, false, tokenName);
                
                if (txid) {
                    buySound.play().catch(() => {});
                    activePositions[tokenAddress] = {
                        name: tokenName,
                        entryPrice: price,
                        currentPrice: price,
                        status: 'Holding',
                        pnl: 0
                    };
                    log(`${tokenName} bought at $${price.toFixed(6)}`, "buy");
                    updatePortfolioUI();
                }
            }
        } catch (error) {}
    }

    // --- 4. PRICE MONITOR & AUTO-SELL ---
    async function monitorPrices() {
        const addresses = Object.keys(activePositions).filter(addr => activePositions[addr].status === 'Holding');
        if (addresses.length === 0) return;

        const batch = addresses.slice(0, 30); 
        try {
            const response = await fetch(`https://api.geckoterminal.com/api/v2/simple/networks/solana/token_price/${batch.join(',')}`);
            const data = await response.json();
            if (!data?.data?.attributes?.token_prices) return;
            
            const prices = data.data.attributes.token_prices;
            const tpLimit = parseFloat(document.getElementById('tpInput').value);
            const slLimit = parseFloat(document.getElementById('slInput').value);

            for (const address of batch) {
                if (prices[address]) {
                    const newPrice = parseFloat(prices[address]);
                    const entryPrice = activePositions[address].entryPrice;
                    const pnlPercent = ((newPrice - entryPrice) / entryPrice) * 100;

                    activePositions[address].currentPrice = newPrice;
                    activePositions[address].pnl = pnlPercent;

                    if (pnlPercent >= tpLimit || pnlPercent <= slLimit) {
                        const reason = pnlPercent > 0 ? `TP +${pnlPercent.toFixed(1)}%` : `SL ${pnlPercent.toFixed(1)}%`;
                        log(`Target Reached for ${activePositions[address].name}: ${reason}. Triggering Auto-Sell...`, "tx");
                        
                        // NOTE: In a full production script, you fetch the SPL token balance here and sell it back to SOL.
                        sellSound.play().catch(() => {});
                        activePositions[address].status = `Sold (${reason})`;
                        log(`${activePositions[address].name} position closed automatically.`, "sell");
                    }
                }
            }
            updatePortfolioUI();
        } catch (error) { }
    }

    // --- 5. UI UPDATES ---
    function updatePortfolioUI() {
        const addresses = Object.keys(activePositions);
        if (addresses.length === 0) return;

        let htmlRender = '';
        for (const address of addresses) {
            const pos = activePositions[address];
            let pnlDisplay = `${pos.pnl > 0 ? '+' : ''}${pos.pnl.toFixed(2)}%`;
            let pnlClass = pos.pnl > 0 ? 'profit' : (pos.pnl < 0 ? 'loss' : 'neutral');

            htmlRender += `
                <tr style="opacity: ${pos.status === 'Holding' ? '1' : '0.4'};">
                    <td><strong>${pos.name}</strong><br><small style="color:#777;">${address.substring(0,6)}...</small></td>
                    <td>$${pos.entryPrice.toFixed(6)}</td>
                    <td>$${pos.currentPrice.toFixed(6)}</td>
                    <td class="${pnlClass}">${pnlDisplay}</td>
                    <td>${pos.status}</td>
                </tr>`;
        }
        portfolioBody.innerHTML = htmlRender;
    }

    // --- ENGINE CONTROLS ---
    startBtn.addEventListener('click', () => {
        if (!payerKeypair) {
            if (!initializeWallet()) return; 
        }

        buySound.play().catch(() => {});
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        
        log("üü¢ FULL AUTO-PILOT ENGAGED. Hands-free scanning started...");
        scanMarket();
        scanInterval = setInterval(scanMarket, 15000); 
        priceMonitorInterval = setInterval(monitorPrices, 20000); 
    });

    stopBtn.addEventListener('click', () => {
        startBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        clearInterval(scanInterval);
        clearInterval(priceMonitorInterval);
        log("üõë Auto-Pilot Disengaged.");
    });

    // Run init log
    logHistory = ["> System Booted. Awaiting Private Key..."];
    logBox.innerHTML = logHistory.join('<br>');

</script>
</body>
</html>
