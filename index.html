<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Solana Auto-Sniper | REAL MAINNET</title>
    
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://bundle.run/bs58@5.0.0"></script>
    <script src="https://bundle.run/buffer@6.0.3"></script>

    <style>
        :root {
            --sol-green: #14F195;
            --sol-purple: #9945FF;
            --bg-dark: #09090b;
            --panel-bg: #18181b;
            --panel-border: #27272a;
            --text-main: #f4f4f5;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            background-color: var(--panel-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--panel-border);
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        h1 { color: var(--sol-green); font-size: 22px; text-align: center; }
        .warning { color: var(--danger); font-size: 12px; text-align: center; font-weight: bold; background: rgba(239,68,68,0.1); padding: 5px; border-radius: 4px; }

        .pk-box { background: #000; padding: 15px; border-radius: 8px; border: 1px solid var(--panel-border); }
        .pk-box label { color: var(--sol-purple); font-size: 12px; font-weight: bold; display: block; margin-bottom: 8px; }
        .pk-input { width: 100%; padding: 10px; background: #111; border: 1px solid #333; color: var(--sol-green); border-radius: 6px; font-family: monospace; }
        
        .filters { display: flex; justify-content: space-between; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; flex-wrap: wrap; gap: 10px; font-size: 14px; }
        .filters div { flex: 1; text-align: center; min-width: 90px; }
        input[type="number"] { background: transparent; border: none; border-bottom: 1px solid var(--sol-green); color: var(--sol-green); width: 50px; text-align: center; font-weight: bold; outline: none; }

        button { width: 100%; padding: 15px; border-radius: 8px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; text-transform: uppercase; }
        .btn-start { background-color: var(--sol-green); color: #000; }
        .btn-stop { background-color: var(--danger); color: #fff; display: none; }

        .table-wrapper { width: 100%; overflow-x: auto; border: 1px solid var(--panel-border); border-radius: 8px; }
        table { width: 100%; min-width: 500px; border-collapse: collapse; text-align: left; font-size: 13px; }
        th, td { padding: 12px; border-bottom: 1px solid var(--panel-border); }
        th { background: rgba(20,241,149,0.1); color: var(--sol-green); }
        
        .log-box { background: #000; padding: 12px; border-radius: 8px; border: 1px solid var(--panel-border); font-family: monospace; height: 200px; overflow-y: auto; font-size: 12px; line-height: 1.6; color: #aaa; }
        .buy-text { color: var(--success); font-weight: bold; }
        .sell-text { color: var(--danger); font-weight: bold; }
        .tx-text { color: #3b82f6; }
    </style>
</head>
<body>

<div class="container">
    <h1>‚ö° Pro Auto-Sniper V4</h1>
    <div class="warning">‚ö†Ô∏è REAL FUNDS ENGINE - REQUIRES BASE58 PRIVATE KEY</div>

    <div class="pk-box" id="pkContainer">
        <label>Burner Wallet Private Key (Auto-Signs TXs)</label>
        <input type="password" id="pkInput" class="pk-input" placeholder="Paste Phantom Private Key here...">
    </div>

    <div class="filters">
        <div><strong>Buy:</strong> $<input type="number" id="usdAmount" value="2"></div>
        <div><strong>TP:</strong> <input type="number" id="tpInput" value="30">%</div>
        <div><strong>SL:</strong> <input type="number" id="slInput" value="-15">%</div>
    </div>

    <button class="btn-start" id="startBtn">üöÄ Start Auto-Pilot</button>
    <button class="btn-stop" id="stopBtn">üõë Stop Engine</button>

    <div class="table-wrapper">
        <table id="portfolioTable">
            <thead>
                <tr>
                    <th>Token</th>
                    <th>Entry</th>
                    <th>Current</th>
                    <th>PnL</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="portfolioBody">
                <tr><td colspan="5" style="text-align:center;">No active trades</td></tr>
            </tbody>
        </table>
    </div>

    <div class="log-box" id="logBox">> System ready. Awaiting Private Key...<br></div>
</div>

<script>
    const SOL_MINT = "So11111111111111111111111111111111111111112"; 
    // Recommended: Replace with a paid RPC like Helius for faster real-world sniping
    const connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com", "confirmed");
    
    let payerKeypair = null; 
    let activePositions = {}; 
    let knownTokens = new Set();
    let scanInterval, priceInterval;
    
    const ui = {
        start: document.getElementById('startBtn'),
        stop: document.getElementById('stopBtn'),
        pk: document.getElementById('pkInput'),
        pkContainer: document.getElementById('pkContainer'),
        logs: document.getElementById('logBox'),
        table: document.getElementById('portfolioBody')
    };

    function log(msg, type = '') {
        const time = new Date().toLocaleTimeString([], { hour12: false });
        let styleClass = '';
        if(type === 'buy') styleClass = 'buy-text';
        if(type === 'sell') styleClass = 'sell-text';
        if(type === 'tx') styleClass = 'tx-text';
        
        ui.logs.innerHTML += `<span style="color:#555">[${time}]</span> <span class="${styleClass}">${msg}</span><br>`;
        ui.logs.scrollTop = ui.logs.scrollHeight;
    }

    // --- 1. WALLET INIT ---
    function initWallet() {
        try {
            const pkVal = ui.pk.value.trim();
            if (!pkVal) throw new Error("Key empty");
            payerKeypair = solanaWeb3.Keypair.fromSecretKey(bs58.decode(pkVal));
            ui.pkContainer.innerHTML = `<div style="color:#10b981; font-weight:bold; text-align:center;">‚úÖ Wallet Loaded: ${payerKeypair.publicKey.toString().slice(0,6)}...</div>`;
            return true;
        } catch (e) {
            log("Invalid Private Key.", "sell-text");
            return false;
        }
    }

    // --- 2. JUPITER API EXECUTION (BUY & SELL) ---
    async function executeSwap(inputMint, outputMint, amountStr, isSell = false) {
        try {
            const quoteRes = await fetch(`https://quote-api.jup.ag/v6/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amountStr}&slippageBps=300`); 
            const quoteData = await quoteRes.json();
            if (quoteData.error) throw new Error(quoteData.error);

            const swapRes = await fetch('https://quote-api.jup.ag/v6/swap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    quoteResponse: quoteData,
                    userPublicKey: payerKeypair.publicKey.toString(),
                    wrapAndUnwrapSol: true,
                    prioritizationFeeLamports: 100000 // Fast execution fee
                })
            });
            const swapData = await swapRes.json();
            if (swapData.error) throw new Error(swapData.error);

            const txBuf = buffer.Buffer.from(swapData.swapTransaction, 'base64');
            const tx = solanaWeb3.VersionedTransaction.deserialize(txBuf);
            
            tx.sign([payerKeypair]); // 100% AUTO SIGN
            const txid = await connection.sendRawTransaction(tx.serialize(), { skipPreflight: true });
            
            log(`TX Broadcasted: solscan.io/tx/${txid}`, 'tx');
            return true;
        } catch (err) {
            log(`Swap Error: ${err.message}`);
            return false;
        }
    }

    // --- 3. AUTO SCAN & BUY ---
    async function scanMarket() {
        try {
            const res = await fetch('https://api.geckoterminal.com/api/v2/networks/solana/new_pools');
            const data = await res.json();
            const pool = data?.data?.[0]?.attributes;
            const tokenAddress = data?.data?.[0]?.relationships?.base_token?.data?.id.replace('solana_', '');
            
            if (!pool || !tokenAddress || knownTokens.has(tokenAddress)) return;
            knownTokens.add(tokenAddress);

            const price = parseFloat(pool.base_token_price_usd);
            const liq = parseFloat(pool.reserve_in_usd);
            const name = pool.name.split(' / ')[0].substring(0, 8);

            if (liq >= 5000 && price > 0) {
                log(`Target: ${name}. Calculating $ USD -> SOL...`, 'tx');
                
                // Get SOL Price
                const solRes = await fetch('https://api.jup.ag/price/v2?ids=So11111111111111111111111111111111111111112');
                const solData = await solRes.json();
                const solPrice = parseFloat(solData.data[SOL_MINT].price);
                
                const targetUsd = parseFloat(document.getElementById('usdAmount').value);
                const lamports = Math.floor((targetUsd / solPrice) * 1000000000); 

                log(`Buying $${targetUsd} of ${name}...`, 'buy');
                const success = await executeSwap(SOL_MINT, tokenAddress, lamports, false);
                
                if (success) {
                    activePositions[tokenAddress] = { name, entryPrice: price, currentPrice: price, status: 'Active', pnl: 0 };
                    renderTable();
                }
            }
        } catch (e) {}
    }

    // --- 4. AUTO SELL (TP/SL) ---
    async function checkPrices() {
        const activeAddrs = Object.keys(activePositions).filter(k => activePositions[k].status === 'Active');
        if (activeAddrs.length === 0) return;

        try {
            const res = await fetch(`https://api.geckoterminal.com/api/v2/simple/networks/solana/token_price/${activeAddrs.join(',')}`);
            const data = await res.json();
            const prices = data?.data?.attributes?.token_prices;
            if(!prices) return;

            const tp = parseFloat(document.getElementById('tpInput').value);
            const sl = parseFloat(document.getElementById('slInput').value);

            for (let addr of activeAddrs) {
                if (prices[addr]) {
                    const newPrice = parseFloat(prices[addr]);
                    const entry = activePositions[addr].entryPrice;
                    const pnl = ((newPrice - entry) / entry) * 100;
                    
                    activePositions[addr].currentPrice = newPrice;
                    activePositions[addr].pnl = pnl;

                    if (pnl >= tp || pnl <= sl) {
                        log(`${activePositions[addr].name} hit ${pnl.toFixed(1)}%. Executing Sell...`, 'sell');
                        activePositions[addr].status = 'Selling...';
                        
                        // 1. Fetch exact token balance on blockchain
                        const accounts = await connection.getParsedTokenAccountsByOwner(payerKeypair.publicKey, { mint: new solanaWeb3.PublicKey(addr) });
                        if(accounts.value.length > 0) {
                            const tokenAmountRaw = accounts.value[0].account.data.parsed.info.tokenAmount.amount;
                            
                            // 2. Execute 100% Sell Swap
                            const sold = await executeSwap(addr, SOL_MINT, tokenAmountRaw, true);
                            activePositions[addr].status = sold ? `Sold (${pnl.toFixed(1)}%)` : 'Sell Failed';
                        } else {
                            activePositions[addr].status = 'No Balance';
                        }
                    }
                }
            }
            renderTable();
        } catch(e) {}
    }

    // --- 5. RENDER UI ---
    function renderTable() {
        let html = '';
        for (let addr in activePositions) {
            const pos = activePositions[addr];
            const pColor = pos.pnl > 0 ? '#10b981' : '#ef4444';
            html += `<tr style="opacity: ${pos.status.includes('Sold') ? '0.4' : '1'}">
                <td><strong>${pos.name}</strong></td>
                <td>$${pos.entryPrice.toFixed(6)}</td>
                <td>$${pos.currentPrice.toFixed(6)}</td>
                <td style="color:${pColor}; font-weight:bold;">${pos.pnl > 0 ? '+':''}${pos.pnl.toFixed(2)}%</td>
                <td>${pos.status}</td>
            </tr>`;
        }
        ui.table.innerHTML = html || '<tr><td colspan="5" style="text-align:center;">No active trades</td></tr>';
    }

    // --- CONTROLS ---
    ui.start.addEventListener('click', () => {
        if (!payerKeypair && !initWallet()) return;
        ui.start.style.display = 'none';
        ui.stop.style.display = 'block';
        log("üü¢ Auto-Pilot Engaged. Scanning blockchain...");
        
        scanMarket();
        scanInterval = setInterval(scanMarket, 10000); 
        priceInterval = setInterval(checkPrices, 15000); 
    });

    ui.stop.addEventListener('click', () => {
        ui.start.style.display = 'block';
        ui.stop.style.display = 'none';
        clearInterval(scanInterval);
        clearInterval(priceInterval);
        log("üõë Auto-Pilot Stopped.");
    });
</script>

</body>
</html>
