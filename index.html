<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Solana Sniper | 1-Tap Mobile</title>
    
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://bundle.run/buffer@6.0.3"></script>

    <style>
        :root {
            --sol-green: #14F195;
            --sol-purple: #9945FF;
            --bg-dark: #09090b;
            --panel-bg: #18181b;
            --panel-border: #27272a;
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            background-color: var(--panel-bg);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--panel-border);
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .header { text-align: center; }
        h1 { color: var(--sol-green); font-size: 22px; margin-bottom: 5px; }
        .subtitle { color: var(--text-muted); font-size: 13px; }

        .btn-connect {
            background: linear-gradient(90deg, var(--sol-purple), #6366f1);
            color: white;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            margin-top: 10px;
        }
        .wallet-display { color: var(--sol-green); font-size: 13px; font-weight: bold; text-align: center; display: none; margin-top: 10px; }

        .filters { display: flex; justify-content: space-between; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; font-size: 14px; flex-wrap: wrap; gap: 10px; }
        .filters div { flex: 1; text-align: center; min-width: 80px; }
        input[type="number"] { background: transparent; border: none; border-bottom: 1px solid var(--sol-green); color: var(--sol-green); font-weight: bold; width: 50px; text-align: center; outline: none; }

        /* 1-TAP ACTION ALERT */
        .action-alert {
            display: none;
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid var(--warning);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }
        .action-alert h3 { color: var(--warning); margin-bottom: 10px; }
        .btn-execute { background: var(--warning); color: #000; font-weight: 900; font-size: 18px; padding: 15px; width: 100%; border: none; border-radius: 8px; cursor: pointer; text-transform: uppercase; }

        .btn-group { display: flex; gap: 10px; flex-direction: column; }
        .action-btn { width: 100%; padding: 15px; border-radius: 8px; border: none; font-weight: bold; font-size: 15px; cursor: pointer; text-transform: uppercase; }
        .btn-start { background-color: var(--sol-green); color: #000; }
        .btn-stop { background-color: var(--danger); color: #fff; display: none; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid var(--panel-border); text-align: left; }
        th { color: var(--sol-green); }
        .profit { color: var(--success); font-weight: bold; }
        .loss { color: var(--danger); font-weight: bold; }

        .log-box { background: #000; padding: 12px; border-radius: 8px; border: 1px solid var(--panel-border); font-family: monospace; height: 180px; overflow-y: auto; font-size: 12px; color: #aaa; line-height: 1.5; }
        .log-buy { color: var(--success); }
        .log-sell { color: var(--danger); }
        .log-alert { color: var(--warning); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>âš¡ Solana Sniper V5</h1>
        <div class="subtitle">1-Tap Mobile Edition (Bypasses Wallet Blocks)</div>
        <button id="connectBtn" class="btn-connect">Connect Phantom</button>
        <div id="walletDisplay" class="wallet-display"></div>
    </div>

    <div id="actionAlert" class="action-alert">
        <h3>ðŸš¨ TARGET FOUND! ðŸš¨</h3>
        <p id="targetDetails" style="margin-bottom: 10px; font-weight: bold; color: white;"></p>
        <button id="executeBuyBtn" class="btn-execute">TAP TO BUY NOW</button>
        <button id="skipBtn" style="background: transparent; border: 1px solid #555; color: #ccc; margin-top: 10px; padding: 8px; width: 100%; border-radius: 5px;">Skip & Resume Scan</button>
    </div>

    <div class="filters">
        <div><strong>Buy:</strong> $<input type="number" id="usdAmount" value="2"></div>
        <div><strong>TP:</strong> <input type="number" id="tpInput" value="30">%</div>
        <div><strong>SL:</strong> <input type="number" id="slInput" value="-15">%</div>
    </div>

    <audio id="buySound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
    <audio id="sellSound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" preload="auto"></audio>

    <div class="btn-group">
        <button class="action-btn btn-start" id="startBtn">ðŸš€ Start Scanner</button>
        <button class="action-btn btn-stop" id="stopBtn">ðŸ›‘ Stop Engine</button>
    </div>

    <div style="overflow-x: auto; border: 1px solid var(--panel-border); border-radius: 8px;">
        <table id="portfolioTable">
            <thead>
                <tr><th>Token</th><th>Entry</th><th>Current</th><th>PnL</th><th>Status</th></tr>
            </thead>
            <tbody id="portfolioBody">
                <tr><td colspan="5" style="text-align:center;">No active positions</td></tr>
            </tbody>
        </table>
    </div>

    <div class="log-box" id="logBox"></div>
</div>

<script>
    const SOL_MINT = "So11111111111111111111111111111111111111112"; 
    let connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com", "confirmed");
    let userPublicKey = null;
    let activePositions = {}; 
    let knownTokens = new Set();
    let scanInterval, priceMonitorInterval;
    let pendingTrade = null; // Holds the trade data waiting for your tap
    
    const ui = {
        start: document.getElementById('startBtn'),
        stop: document.getElementById('stopBtn'),
        connect: document.getElementById('connectBtn'),
        wallet: document.getElementById('walletDisplay'),
        logs: document.getElementById('logBox'),
        table: document.getElementById('portfolioBody'),
        alertBox: document.getElementById('actionAlert'),
        targetDetails: document.getElementById('targetDetails'),
        executeBtn: document.getElementById('executeBuyBtn'),
        skipBtn: document.getElementById('skipBtn'),
        buySound: document.getElementById('buySound'),
        sellSound: document.getElementById('sellSound')
    };

    function log(msg, type = '') {
        const time = new Date().toLocaleTimeString([], { hour12: false });
        let style = '';
        if (type === 'buy') style = 'log-buy';
        if (type === 'sell') style = 'log-sell';
        if (type === 'alert') style = 'log-alert';
        
        ui.logs.innerHTML += `<div class="${style}">[${time}] ${msg}</div>`;
        ui.logs.scrollTop = ui.logs.scrollHeight;
    }

    // --- WALLET CONNECTION ---
    async function connectWallet() {
        const provider = window.solana;
        if (provider?.isPhantom) {
            try {
                const resp = await provider.connect();
                userPublicKey = resp.publicKey;
                ui.connect.style.display = 'none';
                ui.wallet.style.display = 'block';
                ui.wallet.innerText = `Connected: ${userPublicKey.toString().slice(0, 4)}...`;
                log("Phantom linked securely.");
            } catch (err) { log("Connection cancelled."); }
        } else {
            const dappUrl = encodeURIComponent(window.location.href);
            window.location.href = `https://phantom.app/ul/browse/${dappUrl}?ref=${dappUrl}`;
        }
    }
    ui.connect.addEventListener('click', connectWallet);

    window.addEventListener('load', async () => {
        if (window.solana?.isPhantom && window.solana.isConnected) {
            const resp = await window.solana.connect({ onlyIfTrusted: true });
            if (resp) {
                userPublicKey = resp.publicKey;
                ui.connect.style.display = 'none';
                ui.wallet.style.display = 'block';
                ui.wallet.innerText = `Connected: ${userPublicKey.toString().slice(0, 4)}...`;
                log("Auto-connected.");
            }
        }
    });

    // --- TRANSACTION BUILDER ---
    async function executeSwap(inputMint, outputMint, amount) {
        if (!userPublicKey) return false;
        try {
            log(`Fetching Jupiter routing...`);
            // Increased slippage to 5% (500 bps) to prevent new-coin failures
            const quoteResponse = await fetch(`https://quote-api.jup.ag/v6/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amount}&slippageBps=500`); 
            const quoteData = await quoteResponse.json();
            if (quoteData.error) throw new Error(quoteData.error);

            const swapResponse = await fetch('https://quote-api.jup.ag/v6/swap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    quoteResponse: quoteData,
                    userPublicKey: userPublicKey.toString(),
                    wrapAndUnwrapSol: true,
                    prioritizationFeeLamports: 200000 // Very high fee to ensure mobile success
                })
            });
            const swapData = await swapResponse.json();
            if (swapData.error) throw new Error(swapData.error);

            const swapBuf = buffer.Buffer.from(swapData.swapTransaction, 'base64');
            const tx = solanaWeb3.VersionedTransaction.deserialize(swapBuf);

            const signedTx = await window.solana.signTransaction(tx);
            const txid = await connection.sendRawTransaction(signedTx.serialize(), { skipPreflight: true });

            log(`TX Sent! Hash: ${txid.slice(0,8)}...`);
            return true;
        } catch (error) {
            log(`Swap Error: ${error.message}`);
            return false;
        }
    }

    // --- SCANNER ---
    async function scanMarket() {
        try {
            const response = await fetch('https://api.geckoterminal.com/api/v2/networks/solana/new_pools');
            const data = await response.json();
            const pool = data?.data?.[0]?.attributes;
            const tokenAddress = data?.data?.[0]?.relationships?.base_token?.data?.id.replace('solana_', '');
            
            if (!pool || !tokenAddress || knownTokens.has(tokenAddress)) return;
            knownTokens.add(tokenAddress);

            const tokenName = pool.name.split(' / ')[0].substring(0, 8);
            const price = parseFloat(pool.base_token_price_usd);
            const liquidity = parseFloat(pool.reserve_in_usd);

            if (liquidity >= 3000 && price > 0) { // Lowered liquidity requirement slightly
                
                // Get SOL Price
                const solRes = await fetch('https://api.jup.ag/price/v2?ids=So11111111111111111111111111111111111111112');
                const solData = await solRes.json();
                const solPrice = parseFloat(solData.data[SOL_MINT].price);
                
                const targetUsd = parseFloat(document.getElementById('usdAmount').value);
                const lamports = Math.floor((targetUsd / solPrice) * 1000000000); 

                // PAUSE SCANNER & SHOW ALERT
                clearInterval(scanInterval);
                pendingTrade = { tokenAddress, tokenName, lamports, price };
                
                ui.targetDetails.innerText = `Token: ${tokenName} | Liquidity: $${Math.floor(liquidity)}`;
                ui.alertBox.style.display = 'block';
                ui.buySound.play().catch(()=>{});
                log(`ðŸš¨ Target Locked: ${tokenName}. Waiting for manual approval...`, 'alert');
            }
        } catch (error) {}
    }

    // --- 1-TAP EXECUTION BUTTONS ---
    ui.executeBtn.addEventListener('click', async () => {
        if (!pendingTrade) return;
        ui.alertBox.style.display = 'none';
        log(`Triggering buy for ${pendingTrade.tokenName}...`);
        
        const success = await executeSwap(SOL_MINT, pendingTrade.tokenAddress, pendingTrade.lamports);
        
        if (success) {
            activePositions[pendingTrade.tokenAddress] = {
                name: pendingTrade.tokenName,
                entryPrice: pendingTrade.price,
                currentPrice: pendingTrade.price,
                status: 'Holding',
                pnl: 0
            };
            log(`âœ… Successfully bought ${pendingTrade.tokenName}`, 'buy');
            updateUI();
        }
        
        // Resume Scanning
        pendingTrade = null;
        scanInterval = setInterval(scanMarket, 15000);
        log("Scanner resumed.");
    });

    ui.skipBtn.addEventListener('click', () => {
        ui.alertBox.style.display = 'none';
        pendingTrade = null;
        scanInterval = setInterval(scanMarket, 15000);
        log("Trade skipped. Scanner resumed.");
    });

    // --- AUTO SELL (TP/SL) ---
    // NOTE: Sells STILL require you to click the Phantom approval popup, but the bot initiates it automatically.
    async function monitorPrices() {
        const addresses = Object.keys(activePositions).filter(a => activePositions[a].status === 'Holding');
        if (addresses.length === 0) return;

        try {
            const res = await fetch(`https://api.geckoterminal.com/api/v2/simple/networks/solana/token_price/${addresses.join(',')}`);
            const data = await res.json();
            const prices = data?.data?.attributes?.token_prices;
            if (!prices) return;

            const tp = parseFloat(document.getElementById('tpInput').value);
            const sl = parseFloat(document.getElementById('slInput').value);

            for (const addr of addresses) {
                if (prices[addr]) {
                    const newPrice = parseFloat(prices[addr]);
                    const entry = activePositions[addr].entryPrice;
                    const pnl = ((newPrice - entry) / entry) * 100;

                    activePositions[addr].currentPrice = newPrice;
                    activePositions[addr].pnl = pnl;

                    if (pnl >= tp || pnl <= sl) {
                        log(`${activePositions[addr].name} hit Target! Triggering Auto-Sell...`, 'alert');
                        activePositions[addr].status = `Selling...`;
                        
                        const accounts = await connection.getParsedTokenAccountsByOwner(userPublicKey, { mint: new solanaWeb3.PublicKey(addr) });
                        if(accounts.value.length > 0) {
                            const tokenAmountRaw = accounts.value[0].account.data.parsed.info.tokenAmount.amount;
                            const sold = await executeSwap(addr, SOL_MINT, tokenAmountRaw);
                            if (sold) {
                                ui.sellSound.play().catch(()=>{});
                                activePositions[addr].status = `Sold (${pnl.toFixed(1)}%)`;
                                log(`Closed ${activePositions[addr].name}`, 'sell');
                            } else {
                                activePositions[addr].status = 'Holding'; // Reset if user rejects popup
                            }
                        }
                    }
                }
            }
            updateUI();
        } catch (e) {}
    }

    function updateUI() {
        let html = '';
        for (const addr in activePositions) {
            const p = activePositions[addr];
            const pColor = p.pnl > 0 ? 'class="profit"' : (p.pnl < 0 ? 'class="loss"' : '');
            html += `<tr style="opacity: ${p.status.includes('Sold') ? '0.4' : '1'};">
                <td><strong>${p.name}</strong></td>
                <td>$${p.entryPrice.toFixed(6)}</td>
                <td>$${p.currentPrice.toFixed(6)}</td>
                <td ${pColor}>${p.pnl > 0 ? '+':''}${p.pnl.toFixed(2)}%</td>
                <td>${p.status}</td>
            </tr>`;
        }
        ui.table.innerHTML = html || '<tr><td colspan="5" style="text-align:center;">No active positions</td></tr>';
    }

    ui.start.addEventListener('click', () => {
        if (!userPublicKey) { log("Please connect Phantom first!"); return; }
        ui.start.style.display = 'none';
        ui.stop.style.display = 'block';
        
        log("ðŸŸ¢ Scanner Started. Waiting for new pools...");
        scanMarket();
        scanInterval = setInterval(scanMarket, 15000); 
        priceMonitorInterval = setInterval(monitorPrices, 20000); 
    });

    ui.stop.addEventListener('click', () => {
        ui.start.style.display = 'block';
        ui.stop.style.display = 'none';
        clearInterval(scanInterval);
        clearInterval(priceMonitorInterval);
        log("ðŸ›‘ Scanner Stopped.");
    });
</script>
</body>
</html>
